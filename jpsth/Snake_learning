#snakemake -s Snake_learning --cluster "sbatch -p stor -c 8 --parsable -o .snakemake/slurm_logs/%j.out -e .snakemake/slurm_logs/%j.err" --max-jobs-per-second  0.01 --cluster-status ./cluster_status.sh -j 100 -pr gen_all_learning_coupling --config lastfile=40


rule gen_all_learning_coupling:
	input:
		expand("binary/SC/Learning_BZ_XCORR_duo_f{fidx}.mat",fidx=list(range(1,config["lastfile"])))

rule gen_one_learning_coupling:
	input:
	output:
		"binary/SC/Learning_BZ_XCORR_duo_f{fidx}.mat"
	threads: 4
	shell:
		'matlab -noFigureWindows -batch "bz.xcorr_bz({wildcards.fidx},'"criteria='Learning'"')"'

rule gen_SC_sums_file:
	input:
	output:
		"binary/sums_conn_learning.mat"
	threads: 40
	shell:
		'matlab -noFigureWindows -batch "bz.sums_conn(poolsize={threads},criteria='"'Learning')"'"'

rule gen_chain_tag_file:
	input:
	output:
		"binary/LN_chain_tag_all_trl.mat"
	threads: 52
	shell:
		'matlab -noFigureWindows -batch "wave.chain.gen_chain_tag_file(poolsize={threads},'"criteria='Learning'"')"'

rule gen_all_shuf_chain_tag_file:
	input:
		expand("binary/shufs/LN_chain_tag_shuf{cidx}.mat",cidx=list(range(1,101)))

rule gen_one_shuf_chain_tag_file:
	input:
		"binary/LN_bz_shufs.mat"
	output:
		"binary/shufs/LN_chain_tag_shuf{cidx}.mat"
	threads: 26 
	shell:
		'matlab -noFigureWindows -batch "wave.chain.gen_chain_tag_file(poolsize={threads},shuf=true,shufidx={wildcards.cidx}'",criteria='Learning'"')"'

rule gen_all_shuf_ring_tag_file:
	input:
		expand("binary/shufs/LN_ring_tag_shuf{ridx}.mat",ridx=list(range(1,101)))

rule gen_one_shuf_ring_tag_file:
	input:
		"binary/rings_bz_vs_shuf.mat",
		"binary/su_meta.mat",
		"binary/wrs_mux_meta.mat"
	output:
		"binary/shufs/LN_ring_tag_shuf{ridx}.mat"
	shell:
		'matlab -noFigureWindows -batch "bz.rings.rings_time_constant.stats(load_file=false,skip_save=false,compress=true,shuf=true,shufidx={wildcards.ridx}'",criteria='Learning'"')"'


rule replay_shuf_stats:
	input:
		"binary/shufs/LN_chain_tag_shuf{sidx}.mat",
		"binary/shufs/LN_ring_tag_shuf{sidx}.mat"
	output:
		"binary/shus/LN_motif_replay_shuf{sidx}.mat"
	shell:
		'matlab -noFigureWindows -batch "wave.replay.stats_tbl(skip_save=false,shuf=true,shufidx={wildcards.sidx},criteria='"'Learning'"')"'



# bz.shuffle_conn_bz_alt('criteria','Learning','poolsize',2,'fn','LN_bz_shufs.mat','rpt',2)

# wave.chain.chains_consist_incon(skip_save=false,shuf=true,criteria='Learning')
# bz.rings.ring_list_bz_alt(poolsize=52,criteria="Learning")
# wave.chain.sschain_time_const(skip_save=true,criteria='Learning')
# wave.loop.ssloop_time_const(skip_save=true,criteria='Learning')
